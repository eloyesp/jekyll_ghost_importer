#!/usr/bin/env ruby

require 'fileutils'
require 'json'
require 'date'
require 'yaml'

FileUtils.mkdir_p("_posts")
FileUtils.mkdir_p("_drafts")

json = JSON.parse File.read(ARGV.pop), symbolize_names: true

unless json[:data].nil?
  posts = json[:data][:posts]
else
  posts = json[:db].first[:data][:posts]
end

posts.each do |post|
  date = DateTime.parse(post[:published_at]) if post[:published_at]
  slug = post[:slug]
  front_matter_hash = {
    'layout' => "post",
    'title'  => post[:title]
  }
  front_matter_hash['date'] = date.strftime('%Y-%m-%d %H:%M:%S') if date

  body = front_matter_hash.to_yaml + "---\n\n" + post[:markdown]
  draft = post[:status] == 'draft'
  basename = if draft
               "#{ slug }.markdown"
             else
               "#{ date.strftime('%Y-%m-%d') }-#{ slug }.markdown"
             end
  folder = draft ? '_drafts' : '_posts'
  filename = File.join folder, basename
  puts "Importing filename..."
  File.write filename, body
end
